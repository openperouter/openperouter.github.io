<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Integrate OpenPERouter with MetalLB for LoadBalancer service advertisement"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://openperouter.github.io/openperouter/docs/examples/metallb/"><meta property="og:site_name" content="OpenPERouter official docs"><meta property="og:title" content="MetalLB Integration"><meta property="og:description" content="Integrate OpenPERouter with MetalLB for LoadBalancer service advertisement"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-06-15T15:03:22+02:00"><meta property="article:modified_time" content="2025-06-15T15:03:22+02:00"><title>MetalLB Integration | OpenPERouter official docs</title><link rel=icon href=/openperouter/favicon.png><link rel=manifest href=/openperouter/manifest.json><link rel=canonical href=https://openperouter.github.io/openperouter/docs/examples/metallb/><link rel=stylesheet href=/openperouter/book.min.d5e59cb0aa8d22a5813c62cd5e25d3d172489a369c61dc3f622ee96ae1ebb457.css integrity="sha256-1eWcsKqNIqWBPGLNXiXT0XJImjacYdw/Yi7pauHrtFc=" crossorigin=anonymous><script defer src=/openperouter/fuse.min.js></script><script defer src=/openperouter/en.search.min.7ceb4100d6a41c25288e467ea9b012a93b1fc6e6189ecc2fea33ab7a9d91e07d.js integrity="sha256-fOtBANakHCUojkZ+qbASqTsfxuYYnswv6jOrep2R4H0=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/openperouter/><span>OpenPERouter official docs</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/openperouter/docs/concepts/>Concepts</a></li><li><a href=/openperouter/docs/architecture/>Architecture</a></li><li><a href=/openperouter/docs/installation/>Installation</a></li><li><a href=/openperouter/docs/configuration/>Configuration</a></li><li><a href=/openperouter/docs/examples/>Examples</a><ul><li><a href=/openperouter/docs/examples/metallb/ class=active>MetalLB Integration</a></li></ul></li><li><a href=/openperouter/docs/api-reference/>API Reference</a></li><li><a href=/openperouter/docs/contributing/>Contributing</a><ul><li><a href=/openperouter/docs/contributing/devenv/>The development environment</a></li><li><a href=/openperouter/docs/contributing/code-of-conduct/>Code of Conduct</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/openperouter/svg/menu.svg class=book-icon alt=Menu></label><h3>MetalLB Integration</h3><label for=toc-control><img src=/openperouter/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#integration-architecture>Integration Architecture</a><ul><li><a href=#bgp-peering-setup>BGP Peering Setup</a></li><li><a href=#route-flow>Route Flow</a></li></ul></li><li><a href=#configuration-steps>Configuration Steps</a><ul><li><a href=#step-1-configure-bgp-peers>Step 1: Configure BGP Peers</a></li><li><a href=#step-2-configure-ip-address-pools>Step 2: Configure IP Address Pools</a></li><li><a href=#step-3-configure-bgp-advertisement>Step 3: Configure BGP Advertisement</a></li></ul></li><li><a href=#route-advertisement-flow>Route Advertisement Flow</a></li><li><a href=#traffic-flow>Traffic Flow</a></li></ul></nav></aside></header><article class="markdown book-article"><p>This example demonstrates how to integrate OpenPERouter with MetalLB to advertise LoadBalancer services across the EVPN fabric, enabling external access to Kubernetes services.</p><h2 id=overview>Overview
<a class=anchor href=#overview>#</a></h2><p>MetalLB provides load balancing for Kubernetes services by advertising service IPs via BGP. When integrated with OpenPERouter, these BGP routes are automatically converted to EVPN Type 5 routes, making the services reachable across the entire fabric.</p><h2 id=prerequisites>Prerequisites
<a class=anchor href=#prerequisites>#</a></h2><p>Before proceeding with this integration:</p><ol><li><strong>OpenPERouter Configuration</strong>: Ensure OpenPERouter is properly configured with underlay and VNI settings (see <a href=../>base configuration</a>)</li><li><strong>MetalLB Installation</strong>: Install MetalLB in your cluster</li><li><strong>Network Planning</strong>: Plan your service IP ranges for each VNI</li></ol><h2 id=integration-architecture>Integration Architecture
<a class=anchor href=#integration-architecture>#</a></h2><h3 id=bgp-peering-setup>BGP Peering Setup
<a class=anchor href=#bgp-peering-setup>#</a></h3><p>MetalLB establishes BGP sessions with OpenPERouter through the veth interfaces created for each VNI. Since the router-side IP is consistent across all nodes, you only need one BGPPeer configuration per VNI.</p><h3 id=route-flow>Route Flow
<a class=anchor href=#route-flow>#</a></h3><ol><li><strong>Service Creation</strong>: Kubernetes LoadBalancer service is created</li><li><strong>MetalLB Advertisement</strong>: MetalLB advertises the service IP via BGP to OpenPERouter</li><li><strong>EVPN Conversion</strong>: OpenPERouter converts the BGP route to EVPN Type 5 route</li><li><strong>Fabric Distribution</strong>: EVPN route is distributed across the fabric</li><li><strong>External Access</strong>: External hosts can reach the service through the fabric</li></ol><h2 id=configuration-steps>Configuration Steps
<a class=anchor href=#configuration-steps>#</a></h2><h3 id=step-1-configure-bgp-peers>Step 1: Configure BGP Peers
<a class=anchor href=#step-1-configure-bgp-peers>#</a></h3><p>Create BGPPeer resources for each VNI. Since the router IP is consistent across nodes, one peer configuration per VNI is sufficient.</p><h4 id=red-vni-vni-100-bgp-peer>Red VNI (VNI 100) BGP Peer
<a class=anchor href=#red-vni-vni-100-bgp-peer>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>metallb.io/v1beta2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>BGPPeer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>red-vni-peer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>metallb-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myASN</span>: <span style=color:#ae81ff>64515</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>peerASN</span>: <span style=color:#ae81ff>64514</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>peerAddress</span>: <span style=color:#ae81ff>192.169.10.0</span>
</span></span></code></pre></div><h4 id=blue-vni-vni-200-bgp-peer>Blue VNI (VNI 200) BGP Peer
<a class=anchor href=#blue-vni-vni-200-bgp-peer>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>metallb.io/v1beta2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>BGPPeer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>blue-vni-peer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>metallb-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myASN</span>: <span style=color:#ae81ff>64515</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>peerASN</span>: <span style=color:#ae81ff>64514</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>peerAddress</span>: <span style=color:#ae81ff>192.169.11.0</span>
</span></span></code></pre></div><p><strong>Configuration Details:</strong></p><ul><li><strong>myASN</strong>: 64515 (MetalLB&rsquo;s ASN, matches the host ASN in OpenPERouter VNI config)</li><li><strong>peerASN</strong>: 64514 (OpenPERouter&rsquo;s ASN)</li><li><strong>peerAddress</strong>: Router-side veth IP for each VNI</li></ul><h3 id=step-2-configure-ip-address-pools>Step 2: Configure IP Address Pools
<a class=anchor href=#step-2-configure-ip-address-pools>#</a></h3><p>Create IP address pools for your LoadBalancer services. You can create separate pools for different VNIs or use a single pool.</p><h4 id=single-pool-configuration>Single Pool Configuration
<a class=anchor href=#single-pool-configuration>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>metallb.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IPAddressPool</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>service-pool</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>metallb-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>addresses</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>192.168.10.0</span><span style=color:#ae81ff>/24</span>
</span></span></code></pre></div><h4 id=multiple-pools-for-different-vnis>Multiple Pools for Different VNIs
<a class=anchor href=#multiple-pools-for-different-vnis>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Red VNI Pool</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>metallb.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IPAddressPool</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>red-vni-pool</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>metallb-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>addresses</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>192.168.10.0</span><span style=color:#ae81ff>/24</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># Blue VNI Pool</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>metallb.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IPAddressPool</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>blue-vni-pool</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>metallb-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>addresses</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>192.168.20.0</span><span style=color:#ae81ff>/24</span>
</span></span></code></pre></div><h3 id=step-3-configure-bgp-advertisement>Step 3: Configure BGP Advertisement
<a class=anchor href=#step-3-configure-bgp-advertisement>#</a></h3><p>Create BGPAdvertisement resources to enable route advertisement.</p><h4 id=basic-advertisement>Basic Advertisement
<a class=anchor href=#basic-advertisement>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>metallb.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>BGPAdvertisement</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>service-advertisement</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>metallb-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ipAddressPools</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>service-pool</span>
</span></span></code></pre></div><h4 id=vni-specific-advertisement>VNI-Specific Advertisement
<a class=anchor href=#vni-specific-advertisement>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>metallb.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>BGPAdvertisement</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>red-vni-advertisement</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>metallb-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ipAddressPools</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>red-vni-pool</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>communities</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>64514</span>:<span style=color:#ae81ff>100</span>  <span style=color:#75715e># VNI-specific community</span>
</span></span></code></pre></div><h2 id=route-advertisement-flow>Route Advertisement Flow
<a class=anchor href=#route-advertisement-flow>#</a></h2><p>Once configured, the integration works as follows:</p><p><img src=/images/openpeemetallbroutes.svg alt></p><ol><li><strong>Service Creation</strong>: Kubernetes LoadBalancer service is created with an IP from the pool</li><li><strong>MetalLB Processing</strong>: MetalLB assigns an IP and starts advertising it via BGP</li><li><strong>BGP Session</strong>: MetalLB advertises the route to OpenPERouter through the veth interface</li><li><strong>EVPN Conversion</strong>: OpenPERouter converts the BGP route to EVPN Type 5 route</li><li><strong>Fabric Distribution</strong>: The EVPN route is distributed to all fabric routers</li><li><strong>External Reachability</strong>: External hosts can now reach the service through the fabric</li></ol><h2 id=traffic-flow>Traffic Flow
<a class=anchor href=#traffic-flow>#</a></h2><p>When external traffic reaches the service:</p><p><img src=/images/openpeemetallbtraffic.svg alt></p><ol><li><strong>External Request</strong>: External host sends traffic to the service IP</li><li><strong>Fabric Routing</strong>: Fabric routes the traffic to the appropriate VTEP</li><li><strong>VXLAN Encapsulation</strong>: Traffic is encapsulated in VXLAN with the appropriate VNI</li><li><strong>OpenPERouter Processing</strong>: OpenPERouter receives and decapsulates the traffic</li><li><strong>Service Delivery</strong>: Traffic is forwarded to the Kubernetes service endpoint</li></ol></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#integration-architecture>Integration Architecture</a><ul><li><a href=#bgp-peering-setup>BGP Peering Setup</a></li><li><a href=#route-flow>Route Flow</a></li></ul></li><li><a href=#configuration-steps>Configuration Steps</a><ul><li><a href=#step-1-configure-bgp-peers>Step 1: Configure BGP Peers</a></li><li><a href=#step-2-configure-ip-address-pools>Step 2: Configure IP Address Pools</a></li><li><a href=#step-3-configure-bgp-advertisement>Step 3: Configure BGP Advertisement</a></li></ul></li><li><a href=#route-advertisement-flow>Route Advertisement Flow</a></li><li><a href=#traffic-flow>Traffic Flow</a></li></ul></nav></div></aside></main></body></html>