<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Integrate OpenPERouter with Multus for pod to pod layer 2 overlay via EVPN / VXLAN"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://openperouter.github.io/docs/examples/layer2/"><meta property="og:site_name" content="OpenPERouter official docs"><meta property="og:title" content="Layer 2 Integration"><meta property="og:description" content="Integrate OpenPERouter with Multus for pod to pod layer 2 overlay via EVPN / VXLAN"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-06-15T15:03:22+02:00"><meta property="article:modified_time" content="2025-06-15T15:03:22+02:00"><title>Layer 2 Integration | OpenPERouter official docs</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://openperouter.github.io/docs/examples/layer2/><link rel=stylesheet href=/book.min.d5e59cb0aa8d22a5813c62cd5e25d3d172489a369c61dc3f622ee96ae1ebb457.css integrity="sha256-1eWcsKqNIqWBPGLNXiXT0XJImjacYdw/Yi7pauHrtFc=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.f12f0c3b2d24f16623d4d4c8a832fbdbdddc78907e042eea8b46bba6415f6336.js integrity="sha256-8S8MOy0k8WYj1NTIqDL7293ceJB+BC7qi0a7pkFfYzY=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>OpenPERouter official docs</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/docs/concepts/>Concepts</a></li><li><a href=/docs/architecture/>Architecture</a></li><li><a href=/docs/installation/>Installation</a></li><li><a href=/docs/configuration/>Configuration</a></li><li><a href=/docs/examples/>Examples</a><ul><li><a href=/docs/examples/metallb/>MetalLB Integration</a></li><li><a href=/docs/examples/calico/>Calico Integration</a></li><li><a href=/docs/examples/layer2/ class=active>Layer 2 Integration</a></li></ul></li><li><a href=/docs/api-reference/>API Reference</a></li><li><a href=/docs/contributing/>Contributing</a><ul><li><a href=/docs/contributing/devenv/>The development environment</a></li><li><a href=/docs/contributing/code-of-conduct/>Code of Conduct</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Layer 2 Integration</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#overview>Overview</a><ul><li><a href=#example-setup>Example Setup</a></li><li><a href=#pod-to-pod-connectivity>Pod-to-Pod Connectivity</a></li><li><a href=#pod-to-host-connectivity>Pod-to-Host Connectivity</a></li></ul></li><li><a href=#configuration>Configuration</a><ul><li><a href=#openperouter-configuration>OpenPERouter Configuration</a></li><li><a href=#network-attachment-definition>Network Attachment Definition</a></li><li><a href=#workload-configuration>Workload Configuration</a></li></ul></li><li><a href=#validation>Validation</a><ul><li><a href=#pod-l2-to-l2-connectivity>Pod L2-to-L2 Connectivity</a></li><li><a href=#pod-to-external-l3-connectivity>Pod-to-External L3 Connectivity</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><p>This example demonstrates how to integrate OpenPERouter with Multus to have a pod&rsquo;s secondary interface connected to a layer 2 overlay.</p><h2 id=overview>Overview
<a class=anchor href=#overview>#</a></h2><p>A layer 2 VNI is created, exposing a layer 2 domain on the host. On each node, a pod is created with a macvlan interface enslaved to that domain via a Linux bridge.</p><h3 id=example-setup>Example Setup
<a class=anchor href=#example-setup>#</a></h3><p>The full example can be found in the <a href=https://github.com/openperouter/openperouter/examples/layer2>project repository</a> and can be deployed by running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make demo-l2
</span></span></code></pre></div><p>The example configures both an L2 VNI and an L3 VNI. The L2 VNI belongs to the L3 VNI&rsquo;s routing domain. Pods are running on two separate nodes and connected via the overlay. Additionally, the pods are able to reach the broader L3 domain.</p><h3 id=pod-to-pod-connectivity>Pod-to-Pod Connectivity
<a class=anchor href=#pod-to-pod-connectivity>#</a></h3><p>The two pods are on the same L2 subnet. When a pod tries to reach the other, no routing is involved and the L2 traffic gets encapsulated in the corresponding L2 VNI.</p><p><img src=/images/openpel2podtopod.svg alt="Layer 2 Pod to Pod"></p><h3 id=pod-to-host-connectivity>Pod-to-Host Connectivity
<a class=anchor href=#pod-to-host-connectivity>#</a></h3><p>When a pod needs to reach a host belonging to the L3 domain the L2 VNI belongs to, the traffic is routed in the VRF of the OpenPERouter the pod is connected to, and routed according to the Type 5 routes.</p><h2 id=configuration>Configuration
<a class=anchor href=#configuration>#</a></h2><h3 id=openperouter-configuration>OpenPERouter Configuration
<a class=anchor href=#openperouter-configuration>#</a></h3><p>One L3 VNI corresponding to the routing domain, one L2 VNI with the same VRF as the L3 VNI:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>openpe.openperouter.github.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>L3VNI</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>red</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>openperouter-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>asn</span>: <span style=color:#ae81ff>64514</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vni</span>: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>localcidr</span>: <span style=color:#ae81ff>192.169.10.0</span><span style=color:#ae81ff>/24</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hostasn</span>: <span style=color:#ae81ff>64515</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>openpe.openperouter.github.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>L2VNI</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>layer2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>openperouter-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>vni</span>: <span style=color:#ae81ff>110</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vrf</span>: <span style=color:#ae81ff>red</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hostmaster</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>bridge</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>autocreate</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>l2gatewayip</span>: <span style=color:#ae81ff>192.170.1.0</span><span style=color:#ae81ff>/24</span>
</span></span></code></pre></div><p><strong>Configuration Notes:</strong></p><ul><li><strong><code>l2gatewayip</code> field</strong>: Allows each pod to have the same default gateway and be able to send traffic to the outer L3 domain</li><li><strong>hostmaster.autocreate</strong>: Instructs OpenPERouter to create a bridge local to the node that can be used to access the L2 domain</li></ul><h3 id=network-attachment-definition>Network Attachment Definition
<a class=anchor href=#network-attachment-definition>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#e6db74>&#34;k8s.cni.cncf.io/v1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>NetworkAttachmentDefinition</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>macvlan-conf</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>: <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;cniVersion&#34;: &#34;0.3.0&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;type&#34;: &#34;macvlan&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;master&#34;: &#34;br-hs-110&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;mode&#34;: &#34;bridge&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;ipam&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         &#34;type&#34;: &#34;static&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         &#34;routes&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &#34;dst&#34;: &#34;0.0.0.0/0&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &#34;gw&#34;: &#34;192.170.1.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }&#39;</span>
</span></span></code></pre></div><p>A network attachment definition creating a macvlan interface with:</p><ul><li>The bridge created by the OpenPERouter as master</li><li>The default gateway IP assigned to each OpenPERouter instance on every node</li></ul><h3 id=workload-configuration>Workload Configuration
<a class=anchor href=#workload-configuration>#</a></h3><p>Two pods, each running on a different node, with a Multus secondary network corresponding to the network attachment definition we just created:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>second</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>k8s.v1.cni.cncf.io/networks</span>: <span style=color:#e6db74>&#39;[{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;name&#34;: &#34;macvlan-conf&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;ips&#34;: [&#34;192.170.1.4/24&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }]&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>nodeSelector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kubernetes.io/hostname</span>: <span style=color:#ae81ff>pe-kind-worker</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>agnhost</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>k8s.gcr.io/e2e-test-images/agnhost:2.45</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;ip r del default dev eth0 &amp;&amp; /agnhost netexec --http-port=8090&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8090</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>capabilities</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>add</span>: [<span style=color:#e6db74>&#34;NET_ADMIN&#34;</span>]
</span></span></code></pre></div><blockquote><p><strong>Note</strong>: We remove the default gateway so the secondary interface default gateway is the only active one.</p></blockquote><h2 id=validation>Validation
<a class=anchor href=#validation>#</a></h2><h3 id=pod-l2-to-l2-connectivity>Pod L2-to-L2 Connectivity
<a class=anchor href=#pod-l2-to-l2-connectivity>#</a></h3><p>We can check that the first pod is able to curl the second, and the client IP is the one corresponding to the secondary interface:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl exec -it first -- curl 192.170.1.4:8090/clientip
</span></span></code></pre></div><p>Expected output:</p><pre tabindex=0><code>192.170.1.3:44564
</code></pre><p>We can monitor traffic in the OpenPERouter&rsquo;s namespace to validate that the traffic is actually going through the overlay:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>17:56:45.152547 pe-110 P   IP 192.170.1.3 &gt; 192.170.1.4: ICMP echo request, id 12544, seq 0, length <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>17:56:45.152563 vni110 Out IP 192.170.1.3 &gt; 192.170.1.4: ICMP echo request, id 12544, seq 0, length <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>17:56:45.152578 toswitch Out IP 100.65.0.0.50691 &gt; 100.65.0.1.4789: VXLAN, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, vni <span style=color:#ae81ff>110</span>
</span></span><span style=display:flex><span>IP 192.170.1.3 &gt; 192.170.1.4: ICMP echo request, id 12544, seq 0, length <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>17:56:45.152627 toswitch In  IP 100.65.0.1.50691 &gt; 100.65.0.0.4789: VXLAN, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, vni <span style=color:#ae81ff>110</span>
</span></span><span style=display:flex><span>IP 192.170.1.4 &gt; 192.170.1.3: ICMP echo reply, id 12544, seq 0, length <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>17:56:45.152634 vni110 P   IP 192.170.1.4 &gt; 192.170.1.3: ICMP echo reply, id 12544, seq 0, length <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>17:56:45.152637 pe-110 Out IP 192.170.1.4 &gt; 192.170.1.3: ICMP echo reply, id 12544, seq 0, length <span style=color:#ae81ff>64</span>
</span></span></code></pre></div><p><strong>Traffic Flow Analysis:</strong>
The traffic comes through the veth corresponding to the pod&rsquo;s secondary interface, then it&rsquo;s sent out directly via the VXLAN interface and encapsulated.</p><h3 id=pod-to-external-l3-connectivity>Pod-to-External L3 Connectivity
<a class=anchor href=#pod-to-external-l3-connectivity>#</a></h3><p>With <code>192.168.20.2</code> being the IP of the host on the red network:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl exec -it first -- curl 192.168.20.2:8090/clientip
</span></span></code></pre></div><p>Expected output:</p><pre tabindex=0><code>192.170.1.3:37144
</code></pre><p>The pod is able to reach a host on the layer 3 network and the IP is preserved.</p><p>When monitoring traffic:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>18:01:50.406263 pe-110 P   IP 192.170.1.3 &gt; 192.168.20.2: ICMP echo request, id 21760, seq 0, length <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>18:01:50.406267 br-pe-110 In  IP 192.170.1.3 &gt; 192.168.20.2: ICMP echo request, id 21760, seq 0, length <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>18:01:50.406284 br-pe-100 Out IP 192.170.1.3 &gt; 192.168.20.2: ICMP echo request, id 21760, seq 0, length <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>18:01:50.406287 vni100 Out IP 192.170.1.3 &gt; 192.168.20.2: ICMP echo request, id 21760, seq 0, length <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>18:01:50.406295 toswitch Out IP 100.65.0.0.39370 &gt; 100.64.0.1.4789: VXLAN, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, vni <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>IP 192.170.1.3 &gt; 192.168.20.2: ICMP echo request, id 21760, seq 0, length <span style=color:#ae81ff>64</span>
</span></span></code></pre></div><p><strong>Traffic Flow Analysis:</strong>
We see that the packet comes from the veth interface towards the bridge associated with VNI 110 (the default gateway), then is routed to the bridge corresponding to the layer 3 domain and finally encapsulated.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#overview>Overview</a><ul><li><a href=#example-setup>Example Setup</a></li><li><a href=#pod-to-pod-connectivity>Pod-to-Pod Connectivity</a></li><li><a href=#pod-to-host-connectivity>Pod-to-Host Connectivity</a></li></ul></li><li><a href=#configuration>Configuration</a><ul><li><a href=#openperouter-configuration>OpenPERouter Configuration</a></li><li><a href=#network-attachment-definition>Network Attachment Definition</a></li><li><a href=#workload-configuration>Workload Configuration</a></li></ul></li><li><a href=#validation>Validation</a><ul><li><a href=#pod-l2-to-l2-connectivity>Pod L2-to-L2 Connectivity</a></li><li><a href=#pod-to-external-l3-connectivity>Pod-to-External L3 Connectivity</a></li></ul></li></ul></nav></div></aside></main></body></html>